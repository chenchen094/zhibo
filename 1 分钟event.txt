//@version=6
indicator("1 åˆ†é’Ÿæœ€ç‰›æŒ‡æ ‡ v3",
     overlay = true, max_lines_count = 500, max_bars_back = 1000)

//==================== å‚æ•° ====================//
// â€”â€”å¹³æ»‘
group_smoothing = "Smoothing"
h       = input.float(16.0, "NW Smoothing Factor (h)", step = 0.5, tooltip = "é«˜æ–¯æ ¸å¸¦å®½ï¼ˆè¶Šå¤§è¶Šå¹³æ»‘ï¼Œä»…ç”¨å†å²ï¼Œé¿å…é‡ç»˜ï¼‰", group = group_smoothing)
nw_len  = input.int(50,  "NW çª—å£é•¿åº¦(å†å²æ¡æ•°)", minval = 5, maxval = 300, group = group_smoothing)

// â€”â€”å¸ƒæ—
group_boll = "Bollinger Settings (Short/Med/Long)"
short_period = input.int(20, "L1 Period (çŸ­)", inline = "short", group = group_boll)
short_stdev  = input.float(3.0, "Deviation",  inline = "short", group = group_boll)
med_period   = input.int(75, "L1 Period2 (ä¸­)", inline = "med", group = group_boll)
med_stdev    = input.float(4.0, "Deviation",    inline = "med", group = group_boll)
long_period  = input.int(100, "L2 Period (é•¿)", inline = "long", group = group_boll)
long_stdev1  = input.float(4.25, "Deviation A", inline = "long", group = group_boll)
long_stdev2  = input.float(5.0,  "Deviation B", inline = "long", group = group_boll)

// â€”â€”ç»˜å›¾æ˜¾ç¤º
group_graphics = "Plots"
bands_lvl1 = input.bool(true,  "æ˜¾ç¤º Level 1 (çŸ­+ä¸­)", group = group_graphics)
bands_lvl2 = input.bool(true,  "æ˜¾ç¤º Level 2 (é•¿A+é•¿B)", group = group_graphics)
plotsOn    = input.bool(true,  "ç»˜åˆ¶çº¿", group = group_graphics)
plot_thick = input.int(2,      "çº¿å®½", group = group_graphics)

// â€”â€”ä¿¡å·æ£€æµ‹æº
group_logic = "Signal Source"
label_src = input.string("Close", "Label Source", options = ["Pivots", "Close", "High/Low"], group = group_logic, tooltip = "ç”¨å“ªä¸ªä»·æ ¼æ¥æºåˆ¤å®šæ˜¯å¦çªç ´ 1 çº§å¸ƒæ—")
sens      = input.int(4, "Pivots çµæ•åº¦ï¼ˆå·¦å³Kæ•°ï¼‰", minval = 1, group = group_logic)

// â€”â€”é€šçŸ¥
group_notif = "Notifications"
notifs = input.bool(false, "ä¸Š/ä¸‹è½¨é¦–ç ´é€šçŸ¥ (L1)", group = group_notif)

//==================== éé‡ç»˜ NW å¹³æ»‘ ====================//
guass_w(x, hh) =>
    math.exp(-(x * x) / (2.0 * hh * hh))

nw_causal(src, hh, len) =>
    float num = 0.0, den = 0.0
    for i = 0 to len - 1
        w = guass_w(i, hh)
        num += nz(src[i]) * w
        den += w
    den != 0.0 ? num / den : na

// æºï¼šhlc3
tp = (high + low + close) / 3.0
basisNW = nw_causal(tp, h, nw_len)

//==================== NW-Bollinger è®¡ç®— ====================//
stdev_short = ta.stdev(tp - basisNW, short_period)
stdev_med   = ta.stdev(tp - basisNW, med_period)
stdev_long  = ta.stdev(tp - basisNW, long_period)

// Level 1ï¼ˆçŸ­ & ä¸­ï¼‰
BOLU_FIRST = basisNW + short_stdev * stdev_short
BOLD_FIRST = basisNW - short_stdev * stdev_short

BOLU_SECOND = basisNW + med_stdev * stdev_med
BOLD_SECOND = basisNW - med_stdev * stdev_med

// Level 2ï¼ˆé•¿A & é•¿Bï¼‰
BOLU_THIRD  = basisNW + long_stdev1 * stdev_long
BOLD_THIRD  = basisNW - long_stdev1 * stdev_long

BOLU_FOURTH = basisNW + long_stdev2 * stdev_long
BOLD_FOURTH = basisNW - long_stdev2 * stdev_long

//==================== ç»˜å›¾ï¼ˆé¡¶å±‚ï¼‰ ====================//
showBasis = plotsOn
showL1    = plotsOn and bands_lvl1
showL2    = plotsOn and bands_lvl2

p_basis = plot(showBasis ? basisNW : na, title="NW Basis", color=color.new(color.navy, 0), linewidth=plot_thick)
p_u1  = plot(showL1 ? BOLU_FIRST  : na, title="L1 Upper",  color=color.new(color.blue, 0),  linewidth=plot_thick)
p_l1  = plot(showL1 ? BOLD_FIRST  : na, title="L1 Lower",  color=color.new(color.blue, 0),  linewidth=plot_thick)
p_u1b = plot(showL1 ? BOLU_SECOND : na, title="L1 Upper2", color=color.new(color.blue, 70))
p_l1b = plot(showL1 ? BOLD_SECOND : na, title="L1 Lower2", color=color.new(color.blue, 70))
fill(p_u1, p_l1, color=color.new(color.gray, 90))

p_u2a = plot(showL2 ? BOLU_THIRD  : na, title="L2 UpperA", color=color.new(color.purple, 0))
p_l2a = plot(showL2 ? BOLD_THIRD  : na, title="L2 LowerA", color=color.new(color.purple, 0))
p_u2b = plot(showL2 ? BOLU_FOURTH : na, title="L2 UpperB", color=color.new(color.purple, 70))
p_l2b = plot(showL2 ? BOLD_FOURTH : na, title="L2 LowerB", color=color.new(color.purple, 70))

//==================== æ¢è½´ï¼ˆä¿¡å·æºå¯é€‰ï¼Œä¸é‡ç»˜ï¼‰ ====================//
pivot_rad  = sens
float pivot_high = ta.pivothigh(high, pivot_rad, pivot_rad)
float pivot_low  = ta.pivotlow(low,  pivot_rad, pivot_rad)

//==================== èƒœç‡ç»Ÿè®¡ï¼ˆNo-repaintï¼‰ ====================//
group_stats = "Stats / Winrate"
calcEnabled = input.bool(true, "å¯ç”¨ç»Ÿè®¡", group = group_stats)
holdMins    = input.int(10, "ç»Ÿè®¡æŒæœ‰æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰", minval = 1, group = group_stats)
avgMode     = input.string("CALL+PUT", "å¹³å‡é—´éš”ç»Ÿè®¡ä¿¡å·", options=["CALL+PUT","CALL ä»…","PUT ä»…"], group=group_stats)

tfSec    = math.max(1, timeframe.in_seconds(timeframe.period))
holdBars = math.max(1, math.ceil(holdMins * 60.0 / tfSec))

tfText() =>
    string tf = timeframe.period
    if timeframe.isseconds
        tf := str.tostring(timeframe.multiplier) + " ç§’"
    else if timeframe.isminutes
        tf := str.tostring(timeframe.multiplier) + " åˆ†é’Ÿ"
    else if timeframe.isdaily
        tf := str.tostring(timeframe.multiplier) + " å¤©"
    else if timeframe.isweekly
        tf := str.tostring(timeframe.multiplier) + " å‘¨"
    else if timeframe.ismonthly
        tf := str.tostring(timeframe.multiplier) + " æœˆ"
    tf
tf_str = tfText()

// â€”â€”ä»¥â€œ1çº§å¸ƒæ— FIRST è½¨é“â€ä¸ºä¿¡å·åˆ¤å®šï¼ˆé¦–ç ´ï¼‰
bool putBreak = switch label_src
    "Pivots"   => not na(pivot_high) and pivot_high > nz(BOLU_FIRST[pivot_rad])
    "High/Low" => high > BOLU_FIRST
    => close > BOLU_FIRST

bool callBreak = switch label_src
    "Pivots"   => not na(pivot_low)  and pivot_low  < nz(BOLD_FIRST[pivot_rad])
    "High/Low" => low  < BOLD_FIRST
    => close < BOLD_FIRST

// â€”â€”ä»…åœ¨é¦–ç ´é‚£ä¸€æ ¹ä¸”æ”¶ç›˜ç¡®è®¤
putSig  = calcEnabled and barstate.isconfirmed and putBreak  and not putBreak[1]
callSig = calcEnabled and barstate.isconfirmed and callBreak and not callBreak[1]

// â€”â€”è®°å½•å…¥åœºä»·ï¼ˆç”¨ä¿¡å·å½“æ ¹çš„æ”¶ç›˜ä»·ï¼‰
putEntry  = putSig  ? close : na
callEntry = callSig ? close : na

// â€”â€”åˆ°æœŸï¼ˆholdBars æ ¹åï¼‰è¯„ä¼°èƒœè´Ÿ
putDoneNow   = putSig[holdBars]
callDoneNow  = callSig[holdBars]
putEntryN    = putEntry[holdBars]
callEntryN   = callEntry[holdBars]
putWinNow    = putDoneNow  and close < putEntryN
callWinNow   = callDoneNow and close > callEntryN

// â€”â€”ç´¯è®¡è®¡æ•°ï¼ˆä¸é‡ç»˜ï¼šä»…åœ¨æ”¶ç›˜ç»Ÿè®¡ï¼‰
var int putTotal  = 0
var int putWins   = 0
var int callTotal = 0
var int callWins  = 0

if barstate.isconfirmed and calcEnabled
    putTotal  += putDoneNow  ? 1 : 0
    callTotal += callDoneNow ? 1 : 0
    putWins   += putWinNow   ? 1 : 0
    callWins  += callWinNow  ? 1 : 0

wrFmt(wins, total) => total > 0 ? str.tostring(math.round(100 * wins / total, 1)) + "%" : "-"

putWR  = putTotal  > 0 ? 100.0 * putWins  / putTotal  : na
callWR = callTotal > 0 ? 100.0 * callWins / callTotal : na
allTot = putTotal + callTotal
allWin = putWins  + callWins
allWR  = allTot   > 0 ? 100.0 * allWin   / allTot    : na

// ========= å¹³å‡â€œå¤šå°‘æ—¶é—´å¼€ä¸€å•â€ ========= //
edgeSelected = avgMode == "CALL ä»…" ? callSig : avgMode == "PUT ä»…" ? putSig : (callSig or putSig)
var int   prevTs  = na
var float sumMin  = 0.0
var int   cntInt  = 0
if barstate.isconfirmed and calcEnabled and edgeSelected
    if not na(prevTs)
        sumMin += (time_close - prevTs) / 60000.0
        cntInt += 1
    prevTs := time_close
avgMin = cntInt > 0 ? sumMin / cntInt : na

// ================= å·¥å…·ï¼šåŒ—äº¬æ—¶é—´ =================
fmtCN(ts) => str.format("{0,time,yyyy-MM-dd HH:mm:ss}", ts)

// ================= å…¥åœºæ¨é€ï¼ˆæŒ‰ä½ è¦æ±‚æ’åºï¼Œä¸”ä¸å«â€œå½“å‰Kçº¿â€ï¼‰ =================
if barstate.isconfirmed and calcEnabled and callSig
    alert('{"msgtype":"text","text":{"content":"äº‹ä»¶\\nåˆçº¦ï¼š' + syminfo.ticker +
          '\\nä¿¡å·ï¼šæ¶¨ğŸ“ˆï¼ˆCALLï½œé¦–ç ´L1ä¸‹è½¨ï¼‰' +
          '\\nå½“å‰ä»·æ ¼ï¼š' + str.tostring(close, format.mintick) +
          '\\næ—¶é—´ï¼š' + fmtCN(time_close) + '"}}', alert.freq_once_per_bar_close)

if barstate.isconfirmed and calcEnabled and putSig
    alert('{"msgtype":"text","text":{"content":"äº‹ä»¶\\nåˆçº¦ï¼š' + syminfo.ticker +
          '\\nä¿¡å·ï¼šè·ŒğŸ“‰ï¼ˆPUTï½œé¦–ç ´L1ä¸Šè½¨ï¼‰' +
          '\\nå½“å‰ä»·æ ¼ï¼š' + str.tostring(close, format.mintick) +
          '\\næ—¶é—´ï¼š' + fmtCN(time_close) + '"}}', alert.freq_once_per_bar_close)

// ================= ç»“æœæ ‡ç­¾ & æ¨é€ï¼ˆæ ‡é¢˜åŠ â€œäº‹ä»¶â€äºŒå­—ï¼‰ =================
// â€”â€”CALL ç»“æœæ¨é€
if barstate.isconfirmed and calcEnabled and callDoneNow
    msg_call = '{"msgtype":"text","text":{"content":"NW-BB äº‹ä»¶ï¼ˆç»“æœï¼‰\\nç±»å‹ï¼šCALL ' + (callWinNow ? 'èµ¢ âœ…' : 'äº âŒ') +
               '\\nåˆçº¦ï¼š' + syminfo.ticker +
               '\\nå…¥åœºä»·ï¼š' + str.tostring(callEntryN, format.mintick) + 'ï¼ˆ' + fmtCN(time_close[holdBars]) + 'ï¼‰' +
               '\\nåˆ°æœŸä»·ï¼š' + str.tostring(close,      format.mintick) + 'ï¼ˆ' + fmtCN(time_close) + 'ï¼‰"}}'
    alert(msg_call, alert.freq_once_per_bar_close)

// â€”â€”PUT ç»“æœæ¨é€
if barstate.isconfirmed and calcEnabled and putDoneNow
    msg_put =  '{"msgtype":"text","text":{"content":"NW-BB äº‹ä»¶ï¼ˆç»“æœï¼‰\\nç±»å‹ï¼šPUT ' + (putWinNow ? 'èµ¢ âœ…' : 'äº âŒ') +
               '\\nåˆçº¦ï¼š' + syminfo.ticker +
               '\\nå…¥åœºä»·ï¼š' + str.tostring(putEntryN, format.mintick) + 'ï¼ˆ' + fmtCN(time_close[holdBars]) + 'ï¼‰' +
               '\\nåˆ°æœŸä»·ï¼š' + str.tostring(close,     format.mintick) + 'ï¼ˆ' + fmtCN(time_close) + 'ï¼‰"}}'
    alert(msg_put, alert.freq_once_per_bar_close)



// â€”â€”æŠ¥è­¦ï¼ˆé¦–ç ´L1ï¼‰â€” å¯ç”¨äºåˆ›å»º TradingView è­¦æŠ¥
alertcondition(notifs and putSig,  title = "PUT (break L1 upper)", message = "PUT")
alertcondition(notifs and callSig, title = "CALL (break L1 lower)", message = "CALL")
alertcondition(callDoneNow, title = "RESULT CALL (hold)", message = "RESULT_CALL")
alertcondition(putDoneNow,  title = "RESULT PUT (hold)",  message = "RESULT_PUT")