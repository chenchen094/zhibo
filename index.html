<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æç®€ç›´æ’­ - æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; padding: 20px; }
        .container { width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #video-wrapper { width: 100%; background: #000; border-radius: 8px; position: relative; aspect-ratio: 16/9; overflow: hidden; }
        video { width: 100%; height: 100%; }
        #play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); color: white; display: none;
            justify-content: center; align-items: center; cursor: pointer; z-index: 100;
        }
        #status { margin-top: 15px; font-weight: bold; color: #1890ff; }
        .btn { padding: 10px 20px; background: #ff4d4f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="video-wrapper">
        <div id="play-overlay" onclick="manualPlay()">
            <div style="text-align: center;">
                <div style="font-size: 50px;">â–¶</div>
                <p>ç”»é¢å·²å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹è§‚çœ‹</p>
            </div>
        </div>
        <video id="v" autoplay playsinline controls></video>
    </div>
    
    <div id="status">è¿æ¥æœåŠ¡ä¸­...</div>
    
    <div id="controls" style="margin-top:20px; text-align:center;">
        <div id="host-zone" style="display:none;">
            <button class="btn" onclick="startHost()">1. å¼€å¯å±å¹•åˆ†äº«</button>
        </div>
        <div id="viewer-zone" style="display:none;">
            <button class="btn" style="background:#1890ff" onclick="connectToHost()">2. è¿ä¸ä¸Šï¼Ÿç‚¹å‡»æ‰‹åŠ¨åˆ·æ–°è¿æ¥</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const ROOM_ID = "MY_LIVE_094_FINAL"; // å»ºè®®æ”¹å¤æ‚ç‚¹é˜²æ­¢å†²çª
    const peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun.qq.com:3478' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
            ],
            'sdpSemantics': 'unified-plan'
        }
    };

    const videoEl = document.getElementById('v');
    const statusEl = document.getElementById('status');
    const overlay = document.getElementById('play-overlay');
    const params = new URLSearchParams(window.location.search);
    const isHost = params.get('role') === 'host';

    const peer = isHost ? new Peer(ROOM_ID, peerConfig) : new Peer(peerConfig);

    peer.on('open', (id) => {
        if (isHost) {
            document.getElementById('host-zone').style.display = 'block';
            statusEl.innerText = "ä¸»æ’­ç«¯å·²å‡†å¤‡å¥½";
            videoEl.muted = true;
        } else {
            document.getElementById('viewer-zone').style.display = 'block';
            statusEl.innerText = "è§‚ä¼—ç«¯ï¼šæ­£åœ¨è‡ªåŠ¨è¿æ¥...";
            connectToHost();
        }
    });

    // --- ä¸»æ’­ç«¯ï¼šå‘é€æµ ---
    async function startHost() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            videoEl.srcObject = stream;
            statusEl.innerText = "ğŸ”´ ç›´æ’­ä¸­... è¯·ä¿æŒæ­¤é¡µé¢ä¸è¦å…³é—­";
            
            // é‡è¦ï¼šæ¯å½“æœ‰æ–°è§‚ä¼—è¿å…¥ï¼Œå°±é‡æ–°å‘é€æµ
            peer.on('call', call => {
                console.log("æ–°è§‚ä¼—æ¥å…¥ï¼Œå‘é€è§†é¢‘æµ...");
                call.answer(stream);
            });
        } catch (e) {
            statusEl.innerText = "âŒ é‡‡é›†å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•";
        }
    }

    
    // --- è§‚ä¼—ç«¯ï¼šè¿æ¥é€»è¾‘ä¿®æ”¹ ---
async function connectToHost() {
    statusEl.innerText = "æ­£åœ¨å‘èµ·è§†é¢‘åå•†...";
    
    try {
        // ã€å…³é”®æ”¹åŠ¨ã€‘ä¸å†å‘é€ new MediaStream()ï¼Œè€Œæ˜¯å¼ºåˆ¶è¦æ±‚æ¥æ”¶éŸ³è§†é¢‘
        // æˆ‘ä»¬ç”šè‡³å¯ä»¥ä¼ªé€ ä¸€ä¸ªé™éŸ³è½¨é“æ¥éª—è¿‡æµè§ˆå™¨çš„åå•†æœºåˆ¶
        const call = peer.call(ROOM_ID, null, {
            sdpTransform: (sdp) => sdp // ä¿æŒåŸæ ·
        });

        if (!call) {
            statusEl.innerText = "å‘¼å«åˆ›å»ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•";
            return;
        }

        call.on('stream', remoteStream => {
            console.log("âœ… æ”¶åˆ°åª’ä½“æµè½¨é“ï¼");
            videoEl.srcObject = remoteStream;
            overlay.style.display = 'flex'; 
            statusEl.innerText = "âœ… è¿æ¥æˆåŠŸï¼Œç‚¹ç”»é¢å¼€å§‹æ’­æ”¾";
        });

        call.on('error', err => {
            console.error("å‘¼å«ä¸­é€”å‡ºé”™:", err);
            statusEl.innerText = "è¿æ¥ä¸­æ–­: " + err;
        });

    } catch (e) {
        console.error("è¿æ¥å¼‚å¸¸:", e);
    }
}

    function manualPlay() {
        videoEl.play().then(() => {
            overlay.style.display = 'none';
            statusEl.innerText = "æ’­æ”¾ä¸­...";
        }).catch(() => {
            videoEl.muted = true; // å¼ºåˆ¶é™éŸ³æ’­æ”¾
            videoEl.play();
            overlay.style.display = 'none';
            statusEl.innerText = "ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œå·²é™éŸ³æ’­æ”¾ï¼Œè¯·æ‰‹åŠ¨å¼€å¯éŸ³é‡";
        });
    }

    peer.on('error', err => {
        console.error("Peer Error:", err.type);
        if (err.type === 'peer-unavailable') statusEl.innerText = "ä¸»æ’­æœªå¼€æ’­æˆ– ID é”™è¯¯";
        else statusEl.innerText = "è¿æ¥å‡ºé”™: " + err.type;
    });
</script>
</body>
</html>
