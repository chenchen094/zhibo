<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ç½‘é¡µç›´æ’­å·¥å…· (GitHub Pages ç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; background: #f5f7fa; color: #333; margin: 0; padding: 20px; }
        .container { width: 95%; max-width: 900px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        #video-wrapper { width: 100%; background: #000; border-radius: 8px; overflow: hidden; position: relative; aspect-ratio: 16 / 9; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .badge { position: absolute; top: 15px; left: 15px; padding: 6px 12px; border-radius: 20px; color: white; font-size: 14px; font-weight: bold; z-index: 10; }
        #status-bar { margin-top: 15px; padding: 10px; border-radius: 6px; font-size: 14px; text-align: center; background: #eef2f7; }
        .btn-host { background: #ff4d4f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0; font-weight: bold; }
        .tips { font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="container">
    <div id="video-wrapper">
        <div id="role-badge" class="badge" style="background: #999;">æ­£åœ¨åŠ è½½...</div>
        <video id="v" autoplay playsinline controls></video>
    </div>

    <div id="status-bar">æ­£åœ¨è¿æ¥ PeerJS æœåŠ¡å™¨...</div>

    <div id="host-controls" style="display: none; text-align: center;">
        <button class="btn-host" onclick="startHostStream()">ç‚¹å‡»å¼€å¯/é‡ç½®å±å¹•åˆ†äº«</button>
        <p class="tips">æç¤ºï¼šç‚¹å‡»åè¯·åœ¨æµè§ˆå™¨å¼¹çª—ä¸­é€‰æ‹©â€œæ•´ä¸ªå±å¹•â€å¹¶å‹¾é€‰â€œåˆ†äº«ç³»ç»ŸéŸ³é¢‘â€ã€‚</p>
    </div>

    <div class="tips">
        <b>ä½¿ç”¨è¯´æ˜ï¼š</b><br>
        1. ä¸»æ’­ç«¯åœ°å€ï¼š<code id="host-url"></code><br>
        2. è§‚ä¼—ç«¯åœ°å€ï¼š<code id="view-url"></code>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
    // --- é…ç½®åŒº ---
    // ä¸ºäº†é¿å… ID å†²çªï¼Œå»ºè®®å°†ä¸‹é¢çš„å­—ç¬¦ä¸²æ”¹å¾—å¤æ‚ä¸€ç‚¹
    const ROOM_ID = "MY_PRIVATE_LIVE_ROOM_CHENG_094"; 
    
    // ç½‘ç»œæ‰“æ´é…ç½® (STUN æœåŠ¡å™¨)
    // --- ç»ˆæä¿®å¤é…ç½®ï¼šåŠ å…¥ TURN ä¸­è½¬æœåŠ¡å™¨ ---
        const peerConfig = {
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun.qq.com:3478' },
                    // ä½¿ç”¨å¼€æ”¾çš„ä¸­è½¬æœåŠ¡å™¨ï¼Œè§£å†³ 99% çš„è¿æ¥è¶…æ—¶é—®é¢˜
                    {
                        urls: 'turn:openrelay.metered.ca:443',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:80',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    }
                ]
            }
        };

    const videoEl = document.getElementById('v');
    const statusEl = document.getElementById('status-bar');
    const badgeEl = document.getElementById('role-badge');
    const hostControls = document.getElementById('host-controls');

    const params = new URLSearchParams(window.location.search);
    const isHost = params.get('role') === 'host';

    // æ˜¾ç¤ºå½“å‰åœ°å€æ–¹ä¾¿å¤åˆ¶
    const baseUrl = window.location.origin + window.location.pathname;
    document.getElementById('host-url').innerText = baseUrl + "?role=host";
    document.getElementById('view-url').innerText = baseUrl;

    // åˆå§‹åŒ– Peer
    const peer = isHost ? new Peer(ROOM_ID, peerConfig) : new Peer(peerConfig);

    let localStream = null;

    peer.on('open', (id) => {
        console.log('Peer ID:', id);
        if (isHost) {
            badgeEl.innerText = "ä¸»æ’­ç«¯";
            badgeEl.style.background = "#ff4d4f";
            statusEl.innerText = "å°±ç»ªï¼è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å¯åˆ†äº«";
            hostControls.style.display = "block";
            videoEl.muted = true; // ä¸»æ’­ç«¯é™éŸ³é˜²æ­¢å›éŸ³
        } else {
            badgeEl.innerText = "è§‚ä¼—ç«¯";
            badgeEl.style.background = "#1890ff";
            statusEl.innerText = "æ­£åœ¨å¯»æ‰¾ä¸»æ’­...";
            startViewerLogic();
        }
    });

    // --- ä¸»æ’­é€»è¾‘ ---
    async function startHostStream() {
        try {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            // å¼¹å‡ºå±å¹•å…±äº«é€‰æ‹©æ¡†
            localStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" },
                audio: true
            });
            videoEl.srcObject = localStream;
            statusEl.innerText = "ğŸ”´ æ­£åœ¨ç›´æ’­ï¼šç”»é¢å·²åŒæ­¥è‡³äº‘ç«¯";
            statusEl.style.color = "#ff4d4f";

            // å½“æœ‰è§‚ä¼— call è¿›æ¥æ—¶ï¼Œè‡ªåŠ¨åº”ç­”
            peer.on('call', (call) => {
                console.log("æ”¶åˆ°è§‚ä¼—è¿æ¥è¯·æ±‚");
                call.answer(localStream);
            });
        } catch (err) {
            statusEl.innerText = "é”™è¯¯ï¼šæœªæˆæƒå±å¹•å…±äº«";
            console.error(err);
        }
    }

    // --- è§‚ä¼—é€»è¾‘ ---
    function startViewerLogic() {
        let retryCount = 0;
        
        const connectToHost = () => {
            console.log("å°è¯•è¿æ¥ä¸»æ’­...");
            // å‘é€ä¸€ä¸ªç©ºæµè§¦å‘å‘¼å«
            const call = peer.call(ROOM_ID, new MediaStream());
            
            call.on('stream', (remoteStream) => {
                console.log("æˆåŠŸæ¥æ”¶ç”»é¢è½¨é“");
                videoEl.srcObject = remoteStream;
                statusEl.innerText = "âœ… è¿æ¥æˆåŠŸï¼šæ­£åœ¨æ¥æ”¶ç”»é¢";
                statusEl.style.color = "#52c41a";
                // æŸäº›æµè§ˆå™¨éœ€è¦é™éŸ³æ‰èƒ½è‡ªåŠ¨æ’­æ”¾
                videoEl.play().catch(() => {
                    statusEl.innerText = "âœ… è¯·ç‚¹å‡»è§†é¢‘åŒºåŸŸå¼€å¯å£°éŸ³";
                });
            });

            call.on('error', (err) => {
                console.log("å‘¼å«å¤±è´¥:", err);
            });
        };

        // æ¯ 5 ç§’å°è¯•è¿æ¥ä¸€æ¬¡ï¼Œç›´åˆ°æˆåŠŸ
        const timer = setInterval(() => {
            if (videoEl.srcObject) {
                clearInterval(timer);
                return;
            }
            retryCount++;
            statusEl.innerText = `æ­£åœ¨å°è¯•è¿æ¥ä¸»æ’­ (ç¬¬ ${retryCount} æ¬¡)...`;
            connectToHost();
        }, 5000);

        connectToHost();
    }

    // é”™è¯¯å¤„ç†
    peer.on('error', (err) => {
        if (err.type === 'peer-unavailable') {
            statusEl.innerText = "æç¤ºï¼šä¸»æ’­å°šæœªå¼€å¯åˆ†äº«ï¼Œè¯·ç­‰å¾…...";
        } else {
            console.error("PeerJS é”™è¯¯ç±»å‹:", err.type);
            statusEl.innerText = "ç½‘ç»œè¿æ¥å¼‚å¸¸: " + err.type;
        }
    });
</script>

</body>
</html>
