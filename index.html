<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æç®€ç›´æ’­é—´ - ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; padding: 20px; }
        .container { width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #v-box { width: 100%; background: #000; border-radius: 8px; position: relative; aspect-ratio: 16/9; overflow: hidden; }
        video { width: 100%; height: 100%; }
        #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:white; display:none; justify-content:center; align-items:center; cursor:pointer; z-index:100; font-size:20px; }
        #status { margin: 15px 0; font-weight: bold; color: #1890ff; }
        .btn { padding: 12px 24px; background: #ff4d4f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="v-box">
        <div id="overlay" onclick="manualPlay()">ç‚¹å‡»å¼€å¯ç”»é¢ä¸å£°éŸ³</div>
       <video id="v" autoplay muted playsinline webkit-playsinline controls></video>
    </div>
    <div id="status">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
    <div id="ui" style="text-align:center;"></div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const ROOM_ID = "LIVE_CHENG_STABLE_888"; 
    const peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun.qq.com:3478' },
                { urls: 'turn:relay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        }
    };

    const videoEl = document.getElementById('v');
    const statusEl = document.getElementById('status');
    const uiEl = document.getElementById('ui');
    const overlay = document.getElementById('overlay');
    const params = new URLSearchParams(window.location.search);
    const isHost = params.get('role') === 'host';

    let peer = new Peer(isHost ? ROOM_ID : null, peerConfig);
    let localStream = null;

    peer.on('open', (id) => {
        if (isHost) {
            statusEl.innerText = "ä¸»æ’­å·²å°±ç»ª";
            uiEl.innerHTML = '<button class="btn" onclick="startHost()">å¼€å§‹å±å¹•å…±äº«ç›´æ’­</button>';
        } else {
            statusEl.innerText = "è§‚ä¼—ç«¯å·²å°±ç»ªï¼Œå°è¯•è¿æ¥...";
            uiEl.innerHTML = '<button class="btn" style="background:#1890ff" onclick="connect()">ç”»é¢æ²¡å‡ºæ¥ï¼Ÿç‚¹æ­¤é‡è¿</button>';
            setTimeout(connect, 1000); 
        }
    });

    // --- ä¸»æ’­é€»è¾‘ ---
    async function startHost() {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            videoEl.srcObject = localStream;
            videoEl.muted = true;
            statusEl.innerText = "ğŸ”´ ç›´æ’­ä¸­...";
            
            // å…³é”®ï¼šç›‘å¬å‘¼å«å¹¶åº”ç­”
            peer.on('call', (call) => {
                console.log("æ”¶åˆ°å‘¼å«");
                call.answer(localStream);
            });
        } catch (e) {
            statusEl.innerText = "æˆæƒå¤±è´¥";
        }
    }

    // --- è§‚ä¼—é€»è¾‘ ---
    function connect() {
        if (!peer || peer.disconnected) return;
        statusEl.innerText = "æ­£åœ¨åå•†åª’ä½“è½¨é“...";

        // æ ¸å¿ƒä¿®å¤ï¼šå‘é€ä¸€ä¸ªä¼ªé€ çš„é™éŸ³è½¨é“æ¥ç¡®ä¿ SDP åŒ…å« m=video
        const silentStream = createSilentStream();
        const call = peer.call(ROOM_ID, silentStream);

        if (!call) {
            statusEl.innerText = "å‘¼å«è¯·æ±‚æœªå‘å‡ºï¼Œè¯·æ£€æŸ¥ä¸»æ’­æ˜¯å¦åœ¨çº¿";
            return;
        }

        call.on('stream', (remoteStream) => {
            console.log("æ”¶åˆ°è¿œç¨‹è§†é¢‘æµ");
            videoEl.srcObject = remoteStream;
            overlay.style.display = 'flex';
            statusEl.innerText = "âœ… è¿æ¥æˆåŠŸ";
        });

        call.on('error', (e) => {
            statusEl.innerText = "è¿æ¥é”™è¯¯: " + e.type;
        });
    }

    // è¾…åŠ©ï¼šåˆ›å»ºä¸€ä¸ªå¾®å°çš„ç©ºæµæ¥å¼ºåˆ¶åå•†
    function createSilentStream() {
        const canvas = document.createElement("canvas");
        canvas.width = canvas.height = 1;
        const stream = canvas.captureStream(1);
        return stream;
    }

    function manualPlay() {
    // 1. å¼ºåˆ¶é™éŸ³ï¼Œè¿™æ˜¯ç§»åŠ¨ç«¯æ’­æ”¾çš„é€šè¡Œè¯
    videoEl.muted = true; 
    
    videoEl.play().then(() => {
        overlay.style.display = 'none';
        statusEl.innerText = "å·²åŠ è½½ç”»é¢ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»å³ä¸‹è§’éŸ³é‡å›¾æ ‡å¼€å¯å£°éŸ³";
        
        // 2. å°è¯•åœ¨ 1 ç§’åè§£é™¤é™éŸ³ï¼ˆéƒ¨åˆ†æ‰‹æœºå…è®¸äº¤äº’åè§£é™¤ï¼‰
        setTimeout(() => {
            videoEl.muted = false;
        }, 1000);
    }).catch(err => {
        console.error("ç§»åŠ¨ç«¯æ’­æ”¾å¤±è´¥:", err);
        statusEl.innerText = "æ’­æ”¾è¢«æ‹¦æˆªï¼Œè¯·å†æ¬¡ç‚¹å‡»å±å¹•";
    });
}

    peer.on('error', (err) => {
        if (err.type === 'peer-unavailable') statusEl.innerText = "æ‰¾ä¸åˆ°ä¸»æ’­ï¼Œè¯·ç¡®ä¿ä¸»æ’­å·²å¼€å¯é¡µé¢";
        console.error("PeerJS Error:", err.type);
    });
</script>
</body>
</html>
