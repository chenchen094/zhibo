<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ç›´æ’­é—´ - ç¨³å®šç‰ˆ</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; padding: 20px; }
        .container { width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #video-wrapper { width: 100%; background: #000; border-radius: 8px; position: relative; aspect-ratio: 16/9; overflow: hidden; }
        video { width: 100%; height: 100%; }
        /* å…³é”®ï¼šè§‚ä¼—ç‚¹å‡»é®ç½© */
        #play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); color: white; display: flex;
            justify-content: center; align-items: center; cursor: pointer; z-index: 100;
        }
        #status { margin-top: 15px; font-size: 14px; color: #666; }
        .btn { padding: 10px 20px; background: #ff4d4f; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="video-wrapper">
        <div id="play-overlay" style="display: none;" onclick="manualPlay()">
            <div style="text-align: center;">
                <div style="font-size: 50px;">â–¶</div>
                <p>æ£€æµ‹åˆ°ç›´æ’­æµï¼Œç‚¹å‡»å¼€å§‹è§‚çœ‹</p>
            </div>
        </div>
        <video id="v" autoplay playsinline controls></video>
    </div>
    <div id="status">æ­£åœ¨åˆå§‹åŒ–...</div>
    <div id="host-zone" style="display:none; margin-top:15px; text-align:center;">
        <button class="btn" onclick="startHost()">1. ç‚¹å‡»å¼€å¯å±å¹•åˆ†äº«</button>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const ROOM_ID = "MY_PRIVATE_LIVE_ROOM_CHENG_094"; 
    const peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun.qq.com:3478' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        }
    };

    const videoEl = document.getElementById('v');
    const statusEl = document.getElementById('status');
    const overlay = document.getElementById('play-overlay');
    const params = new URLSearchParams(window.location.search);
    const isHost = params.get('role') === 'host';

    const peer = isHost ? new Peer(ROOM_ID, peerConfig) : new Peer(peerConfig);

    peer.on('open', (id) => {
        if (isHost) {
            document.getElementById('host-zone').style.display = 'block';
            statusEl.innerText = "ä¸»æ’­ç«¯å°±ç»ª";
            videoEl.muted = true;
        } else {
            statusEl.innerText = "è§‚ä¼—ç«¯ï¼šæ­£åœ¨å‘¼å«ä¸»æ’­...";
            startViewer();
        }
    });

    // --- ä¸»æ’­é€»è¾‘ ---
    async function startHost() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            videoEl.srcObject = stream;
            statusEl.innerText = "ğŸ”´ ç›´æ’­ä¸­...";
            peer.on('call', call => {
                console.log("æ”¶åˆ°è¿æ¥è¯·æ±‚ï¼Œå‘é€æµ...");
                call.answer(stream);
            });
        } catch (e) { statusEl.innerText = "æœªæˆæƒåˆ†äº«"; }
    }

    // --- è§‚ä¼—é€»è¾‘ ---
    function startViewer() {
        const connect = () => {
            const call = peer.call(ROOM_ID, new MediaStream());
            call.on('stream', remoteStream => {
                console.log("æ”¶åˆ°æµï¼Œæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®");
                videoEl.srcObject = remoteStream;
                overlay.style.display = 'flex'; // æ˜¾ç¤ºç‚¹å‡»å±‚
                statusEl.innerText = "è¿æ¥æˆåŠŸï¼Œè¯·ç‚¹å‡»ç”»é¢å¼€å§‹è§‚çœ‹";
            });
        };
        setInterval(() => { if(!videoEl.srcObject) connect(); }, 5000);
        connect();
    }

    // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾ï¼ˆç»•è¿‡æµè§ˆå™¨é™åˆ¶ï¼‰
    function manualPlay() {
        videoEl.play().then(() => {
            overlay.style.display = 'none';
            statusEl.innerText = "æ­£åœ¨æ’­æ”¾...";
        }).catch(err => {
            console.error("æ’­æ”¾å¤±è´¥:", err);
            // å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œå°è¯•é™éŸ³æ’­æ”¾
            videoEl.muted = true;
            videoEl.play();
            overlay.style.display = 'none';
            statusEl.innerText = "é™éŸ³æ’­æ”¾ä¸­ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰ï¼Œè¯·æ‰‹åŠ¨å¼€å¯å£°éŸ³";
        });
    }

    peer.on('error', err => {
        if(err.type === 'peer-unavailable') statusEl.innerText = "ä¸»æ’­è¿˜æ²¡å¼€æ’­ï¼Œè¯·ç­‰å¾…...";
    });
</script>
</body>
</html>
